# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  schedule:
    - cron: '0 2 * * *'
  # Triggers the workflow on push or pull request events but only for the "main" branch
  # push:
  #   branches: [ "main" ]
  # pull_request:
  #   branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
env:
  ARM_TOOLCHAIN_32: arm-none-linux-gnueabihf
  ARM_TOOLCHAIN_64: aarch64-none-linux-gnu
  TOOLCHAIN_VER: 12.3.rel1
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ðŸ–¥ï¸ æ£€æŸ¥æœåŠ¡å™¨é…ç½®
        run: |
          echo "è­¦å‘Šâš "
          echo "è‹¥åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½ä¸è¶³ï¼ŒåŠ¡å¿…åŠæ—¶å–æ¶ˆï¼Œé‡æ–°è¿è¡Œï¼"
          echo "å·²çŸ¥ç¼–è¯‘æˆåŠŸCPUåž‹å·ï¼š8370C,8171M"
          echo "å·²çŸ¥æ€§èƒ½ä¸è¶³CPUåž‹å·ï¼š8272CL,E5ç³»åˆ—"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
          echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼š"
          sudo lshw -short -C memory | grep GiB
          echo -e "\n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo -e  "ç¡¬ç›˜æ•°é‡ï¼š$(ls /dev/sd* | grep -v [1-9] | wc -l) \n"
          echo "ç¡¬ç›˜è¯¦æƒ…ï¼š"
          df -Th
          sudo mount -o remount,rw /mnt/
          sudo mount
          ls -ld /mnt
          sudo chmod 0755 /mnt/
          sudo rm -rf /mnt/openwrt;sudo mkdir -p /mnt/openwrt
          sudo chmod 0777 /mnt/openwrt/
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH
        uses: MrSquaare/ssh-setup-action@v3
        with:
          host: gitee.com
          private-key: ${{ secrets.UDP_GW }}
      - name: ðŸ“‚ Checkout private tools
        run: |
          git clone git@gitee.com:hstarlive/XPlaneUDP.git --depth=1

      - name: ðŸ› ï¸ Install latest stable
        uses: dtolnay/rust-toolchain@master
        with:
            toolchain: stable
            target: aarch64-unknown-linux-gnu, armv7-unknown-linux-gnueabihf, x86_64-pc-windows-msvc
            components: rustfmt, clippy
      - name: ðŸ—‚ï¸ rust-cache
        uses:  Swatinem/rust-cache@v2
      - name: ðŸ“¦ install cargo-xwin
        uses: actions-rs/cargo@v1
        with:
            command: install 
            args: --locked cargo-xwin
      - name: ðŸ“¦ install cargo-make
        uses: actions-rs/cargo@v1
        with:
          command: install 
          args: cargo-make
      - name: ðŸ› ï¸ get arm-gnu-toolchain
        run: |
          wget -O /opt/arm-none-linux-gnueabihf.tar.xz https://developer.arm.com/-/media/Files/downloads/gnu/$TOOLCHAIN_VER/binrel/arm-gnu-toolchain-$TOOLCHAIN_VER-x86_64-arm-none-linux-gnueabihf.tar.xz
          mkdir -p /opt/arm-none-linux-gnueabihf
          tar -vxf /opt/arm-none-linux-gnueabihf.tar.xz -C /opt/arm-none-linux-gnueabihf --strip-components 1
          ln -s /opt/arm-none-linux-gnueabihf/bin/arm-none-linux-gnueabihf-gcc /opt/arm-none-linux-gnueabihf/bin/arm-linux-gnueabihf-gcc
          wget -O /opt/aarch64-none-linux-gnu.tar.xz https://developer.arm.com/-/media/Files/downloads/gnu/$TOOLCHAIN_VER/binrel/arm-gnu-toolchain-$TOOLCHAIN_VER-x86_64-aarch64-none-linux-gnu.tar.xz
          mkdir -p /opt/aarch64-none-linux-gnu
          tar -vxf /opt/aarch64-none-linux-gnu.tar.xz -C /opt/aarch64-none-linux-gnu --strip-components 1
          ln -s /opt/aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-gcc /opt/aarch64-none-linux-gnu/bin/aarch64-linux-gnu-gcc
          echo "/opt/aarch64-none-linux-gnu/bin" >> "$GITHUB_PATH"
          echo "/opt/arm-none-linux-gnueabihf/bin" >> "$GITHUB_PATH"
          echo test, and deploy your project.          

      # Runs a set of commands using the runners shell
      - name: ðŸ—ï¸ build
        run: |
          cd XPlaneUDP
          cargo make all
      - name: ðŸ•’ Get timestamp
        id: timestamp
        run: |
          (export TZ='Asia/Shanghai'; echo "timestamp=$(date +'%Y%m%d_%H%M')" >> $GITHUB_OUTPUT)
      - name: ðŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: XPlaneUDP-${{ steps.timestamp.outputs.timestamp }}
          path: XPlaneUDP/target/*.gz

      # - name: Release
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     files: XPlaneUDP/target/*.gz
      #     tag_name: test
      #     name: ${{ steps.date.outputs.date }}